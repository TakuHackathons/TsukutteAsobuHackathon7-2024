(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5405],{8312:function(e,t,i){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return i(1934)}])},1934:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return H}});var a=i(5893),n=i(7294),s=i(9477),r=i(3818),o=i(7836);let l=new s.Pa4,d=new s._fP,h=new s.USm;class c extends r.cw{update(e){if(this.target&&this.autoUpdate){this.lookAt(this.target.getWorldPosition(l));let t=this._yaw,i=this._pitch,a=t,n=i;if(this.userTarget){this.lookAt(this.userTarget.getWorldPosition(l)),(this.userLimitAngle<Math.abs(this._yaw)||this.userLimitAngle<Math.abs(this._pitch))&&(this._yaw=t,this._pitch=i);let o=1-Math.exp(-this.smoothFactor*e);this._yawDamped+=(this._yaw-this._yawDamped)*o,this._pitchDamped+=(this._pitch-this._pitchDamped)*o;let c=1-s.M8C.smoothstep(Math.sqrt(t*t+i*i),30,90);a=s.M8C.lerp(t,.6*this._yawDamped,c),n=s.M8C.lerp(i,.6*this._pitchDamped,c),h.set(-this._pitchDamped*s.M8C.DEG2RAD,this._yawDamped*s.M8C.DEG2RAD,0,r.cw.EULER_ORDER),d.setFromEuler(h);let u=this.humanoid.getRawBoneNode("head");this._tempFirstPersonBoneQuat.copy(u.quaternion),u.quaternion.slerp(d,.4),u.updateMatrixWorld()}this.enableSaccade&&(.5<this._saccadeTimer&&.05>Math.random()&&(this._saccadeYaw=(2*Math.random()-1)*5,this._saccadePitch=(2*Math.random()-1)*5,this._saccadeTimer=0),this._saccadeTimer+=e,a+=this._saccadeYaw,n+=this._saccadePitch,this.applier.applyYawPitch(a,n)),this._needsUpdate=!1}this._needsUpdate&&(this._needsUpdate=!1,this.applier.applyYawPitch(this._yaw,this._pitch))}revertFirstPersonBoneQuat(){this.userTarget&&this.humanoid.getNormalizedBoneNode("head").quaternion.copy(this._tempFirstPersonBoneQuat)}constructor(e,t){super(e,t),this.smoothFactor=4,this.userLimitAngle=90,this._saccadeYaw=0,this._saccadePitch=0,this._saccadeTimer=0,this._yawDamped=0,this._pitchDamped=0,this._tempFirstPersonBoneQuat=new s._fP,this.enableSaccade=!0}}class u extends r.Hn{get name(){return"VRMLookAtSmootherLoaderPlugin"}async afterRoot(e){await super.afterRoot(e);let t=e.userData.vrmHumanoid,i=e.userData.vrmLookAt;if(null!=t&&null!=i){let a=new c(t,i.applier);a.copy(i),e.userData.vrmLookAt=a}}}class p{update(){this.analyser.getFloatTimeDomainData(this.timeDomainData);let e=0;for(let t=0;t<2048;t++)e=Math.max(e,Math.abs(this.timeDomainData[t]));return(e=1/(1+Math.exp(-45*e+5)))<.1&&(e=0),{volume:e}}async playFromArrayBuffer(e,t){let i=await this.audio.decodeAudioData(e),a=this.audio.createBufferSource();a.buffer=i,a.connect(this.audio.destination),a.connect(this.analyser),a.start(),t&&a.addEventListener("ended",t)}async playFromURL(e,t){let i=await fetch(e),a=await i.arrayBuffer();this.playFromArrayBuffer(a,t)}constructor(e){this.audio=e,this.analyser=e.createAnalyser(),this.timeDomainData=new Float32Array(2048)}}class m{constructor(e,t){this._lookAtTarget=new s.Tme,t.add(this._lookAtTarget),e.lookAt&&(e.lookAt.target=this._lookAtTarget)}}class _{setEnable(e){return(this._isAutoBlink=e,this._isOpen)?0:this._remainingTime}update(e){if(this._remainingTime>0){this._remainingTime-=e;return}if(this._isOpen&&this._isAutoBlink){this.close();return}this.open()}close(){this._isOpen=!1,this._remainingTime=.12,this._expressionManager.setValue("blink",1)}open(){this._isOpen=!0,this._remainingTime=5,this._expressionManager.setValue("blink",0)}constructor(e){this._expressionManager=e,this._remainingTime=0,this._isAutoBlink=!0,this._isOpen=!0}}class v{playEmotion(e){var t,i,a;if("neutral"!=this._currentEmotion&&(null===(i=this._expressionManager)||void 0===i||i.setValue(this._currentEmotion,0)),"neutral"==e){null===(a=this._autoBlink)||void 0===a||a.setEnable(!0),this._currentEmotion=e;return}let n=(null===(t=this._autoBlink)||void 0===t?void 0:t.setEnable(!1))||0;this._currentEmotion=e,setTimeout(()=>{var t;null===(t=this._expressionManager)||void 0===t||t.setValue(e,1)},1e3*n)}lipSync(e,t){if(this._currentLipSync){var i;null===(i=this._expressionManager)||void 0===i||i.setValue(this._currentLipSync.preset,0)}this._currentLipSync={preset:e,value:t}}update(e){if(this._autoBlink&&this._autoBlink.update(e),this._currentLipSync){var t;let e="neutral"===this._currentEmotion?.5*this._currentLipSync.value:.25*this._currentLipSync.value;null===(t=this._expressionManager)||void 0===t||t.setValue(this._currentLipSync.preset,e)}}constructor(e,t){this._autoLookAt=new m(e,t),this._currentEmotion="neutral",this._currentLipSync=null,e.expressionManager&&(this._expressionManager=e.expressionManager,this._autoBlink=new _(e.expressionManager))}}class g{playEmotion(e){this._expressionController.playEmotion(e)}lipSync(e,t){this._expressionController.lipSync(e,t)}update(e){this._expressionController.update(e)}constructor(e,t){this._expressionController=new v(e,t)}}class f{async loadVRM(e){let t=new o.E;t.register(e=>new r.XX(e,{lookAtPlugin:new u(e)}));let i=await t.loadAsync(e),a=this.vrm=i.userData.vrm;a.scene.name="VRMRoot",r.ck.rotateVRM0(a),this.mixer=new s.Xcj(a.scene),this.emoteController=new g(a,this._lookAtTargetParent)}unLoadVrm(){this.vrm&&(r.ck.deepDispose(this.vrm.scene),this.vrm=null)}async loadAnimation(e){let{vrm:t,mixer:i}=this;if(null==t||null==i)throw Error("You have to load VRM first");let a=e.createAnimationClip(t);i.clipAction(a).play()}async speak(e,t){var i;null===(i=this.emoteController)||void 0===i||i.playEmotion(t),await new Promise(t=>{var i;null===(i=this._lipSync)||void 0===i||i.playFromArrayBuffer(e,()=>{t(!0)})})}update(e){var t,i,a,n;if(this._lipSync){let{volume:e}=this._lipSync.update();null===(n=this.emoteController)||void 0===n||n.lipSync("aa",e)}null===(t=this.emoteController)||void 0===t||t.update(e),null===(i=this.mixer)||void 0===i||i.update(e),null===(a=this.vrm)||void 0===a||a.update(e)}constructor(e){this._lookAtTargetParent=e,this._lipSync=new p(new AudioContext)}}class w{createAnimationClip(e){let t=[];if(t.push(...this.createHumanoidTracks(e)),null!=e.expressionManager&&t.push(...this.createExpressionTracks(e.expressionManager)),null!=e.lookAt){let e=this.createLookAtTrack("lookAtTargetParent.quaternion");null!=e&&t.push(e)}return new s.m7l("Clip",this.duration,t)}createHumanoidTracks(e){var t,i;let a=e.humanoid,n=e.meta.metaVersion,r=[];for(let[e,i]of this.humanoidTracks.rotation.entries()){let o=null===(t=a.getNormalizedBoneNode(e))||void 0===t?void 0:t.name;if(null!=o){let e=new s.yC1("".concat(o,".quaternion"),i.times,i.values.map((e,t)=>"0"===n&&t%2==0?-e:e));r.push(e)}}for(let[e,t]of this.humanoidTracks.translation.entries()){let s=null===(i=a.getNormalizedBoneNode(e))||void 0===i?void 0:i.name;if(null!=s){let e=this.restHipsPosition.y,i=a.getNormalizedAbsolutePose().hips.position[1]/e,o=t.clone();o.values=o.values.map((e,t)=>("0"===n&&t%3!=1?-e:e)*i),o.name="".concat(s,".position"),r.push(o)}}return r}createExpressionTracks(e){let t=[];for(let[i,a]of this.expressionTracks.entries()){let n=e.getExpressionTrackName(i);if(null!=n){let e=a.clone();e.name=n,t.push(e)}}return t}createLookAtTrack(e){if(null==this.lookAtTrack)return null;let t=this.lookAtTrack.clone();return t.name=e,t}constructor(){this.duration=0,this.restHipsPosition=new s.Pa4,this.humanoidTracks={translation:new Map,rotation:new Map},this.expressionTracks=new Map,this.lookAtTrack=null}}function y(e,t){let i=e.length,a=[],n=[],s=0;for(let r=0;r<i;r++){let i=e[r];s<=0&&(s=t,n=[],a.push(n)),n.push(i),s--}return a}let x=new s.yGw,k=new s.Pa4,b=new s._fP,A=new s._fP,M=new s._fP;class P{get name(){return"VRMC_vrm_animation"}async afterRoot(e){var t;let i=e.parser.json,a=i.extensionsUsed;if(null==a||-1==a.indexOf(this.name))return;let n=null===(t=i.extensions)||void 0===t?void 0:t[this.name];if(null==n)return;let r=this._createNodeMap(n),o=await this._createBoneWorldMatrixMap(e,n),l=n.humanoid.humanBones.hips.node,d=(await e.parser.getDependency("node",l)).getWorldPosition(new s.Pa4),h=e.animations.map((e,t)=>{let a=i.animations[t],n=this._parseAnimation(e,a,r,o);return n.restHipsPosition=d,n});e.userData.vrmAnimations=h}_createNodeMap(e){var t,i,a,n,s;let r=new Map,o=new Map,l=null===(t=e.humanoid)||void 0===t?void 0:t.humanBones;l&&Object.entries(l).forEach(e=>{let[t,i]=e,{node:a}=i;r.set(a,t)});let d=null===(i=e.expressions)||void 0===i?void 0:i.preset;d&&Object.entries(d).forEach(e=>{let[t,i]=e,{node:a}=i;o.set(a,t)});let h=null===(a=e.expressions)||void 0===a?void 0:a.custom;return h&&Object.entries(h).forEach(e=>{let[t,i]=e,{node:a}=i;o.set(a,t)}),{humanoidIndexToName:r,expressionsIndexToName:o,lookAtIndex:null!==(s=null===(n=e.lookAt)||void 0===n?void 0:n.node)&&void 0!==s?s:null}}async _createBoneWorldMatrixMap(e,t){e.scene.updateWorldMatrix(!1,!0);let i=await e.parser.getDependencies("node"),a=new Map;for(let[e,{node:r}]of Object.entries(t.humanoid.humanBones)){let t=i[r];if(a.set(e,t.matrixWorld),"hips"===e){var n,s;a.set("hipsParent",null!==(s=null===(n=t.parent)||void 0===n?void 0:n.matrixWorld)&&void 0!==s?s:x)}}return a}_parseAnimation(e,t,i,a){let n=e.tracks,o=t.channels,l=new w;return l.duration=e.duration,o.forEach((e,t)=>{let{node:o,path:d}=e.target,h=n[t];if(null==o)return;let c=i.humanoidIndexToName.get(o);if(null!=c){let e=r.j$[c];for(;null!=e&&null==a.get(e);)e=r.j$[e];if(null!=e||(e="hipsParent"),"translation"===d){let e=a.get("hipsParent"),t=y(h.values,3).flatMap(t=>k.fromArray(t).applyMatrix4(e).toArray()),i=h.clone();i.values=new Float32Array(t),l.humanoidTracks.translation.set(c,i)}else if("rotation"===d){let t=a.get(c),i=a.get(e);b.setFromRotationMatrix(t).normalize().invert(),A.setFromRotationMatrix(i).normalize();let n=y(h.values,4).flatMap(e=>M.fromArray(e).premultiply(A).multiply(b).toArray()),s=h.clone();s.values=new Float32Array(n),l.humanoidTracks.rotation.set(c,s)}else throw Error('Invalid path "'.concat(d,'"'));return}let u=i.expressionsIndexToName.get(o);if(null!=u){if("translation"===d){let e=h.times,t=new Float32Array(h.values.length/3);for(let e=0;e<t.length;e++)t[e]=h.values[3*e];let i=new s.dUE("".concat(u,".weight"),e,t);l.expressionTracks.set(u,i)}else throw Error('Invalid path "'.concat(d,'"'));return}if(o===i.lookAtIndex){if("rotation"===d)l.lookAtTrack=h;else throw Error('Invalid path "'.concat(d,'"'))}}),l}constructor(e){this.parser=e}}let T=new o.E;async function E(e){let t=(await T.loadAsync(e)).userData.vrmAnimations[0];return null!=t?t:null}T.register(e=>new P(e));var C=i(9365),D=i(1752),R=i.n(D);function S(e){let{publicRuntimeConfig:t}=R()();return t.root+e}class L{loadVrm(e){var t;(null===(t=this.model)||void 0===t?void 0:t.vrm)&&this.unloadVRM(),this.model=new f(this._camera||new s.Tme),this.model.loadVRM(e).then(async()=>{var e;if(!(null===(e=this.model)||void 0===e?void 0:e.vrm))return;this.model.vrm.scene.traverse(e=>{e.frustumCulled=!1}),this._scene.add(this.model.vrm.scene);let t=await E(S("/idle_loop.vrma"));t&&this.model.loadAnimation(t),requestAnimationFrame(()=>{this.resetCamera()})})}unloadVRM(){var e,t;(null===(e=this.model)||void 0===e?void 0:e.vrm)&&(this._scene.remove(this.model.vrm.scene),null===(t=this.model)||void 0===t||t.unLoadVrm())}setup(e){var t,i;let a=e.parentElement,n=(null==a?void 0:a.clientWidth)||e.width,r=(null==a?void 0:a.clientHeight)||e.height;this._renderer=new s.CP7({canvas:e,alpha:!0,antialias:!0}),this._renderer.outputColorSpace=s.KI_,this._renderer.setSize(n,r),this._renderer.setPixelRatio(window.devicePixelRatio),this._camera=new s.cPb(20,n/r,.1,20),this._camera.position.set(0,1.3,1.5),null===(t=this._cameraControls)||void 0===t||t.target.set(0,1.3,0),null===(i=this._cameraControls)||void 0===i||i.update(),this._cameraControls=new C.z(this._camera,this._renderer.domElement),this._cameraControls.screenSpacePanning=!0,this._cameraControls.update(),window.addEventListener("resize",()=>{this.resize()}),this.isReady=!0,this.update()}resize(){if(!this._renderer)return;let e=this._renderer.domElement.parentElement;e&&(this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(e.clientWidth,e.clientHeight),this._camera&&(this._camera.aspect=e.clientWidth/e.clientHeight,this._camera.updateProjectionMatrix()))}resetCamera(){var e,t,i,a,n;let r=null===(t=this.model)||void 0===t?void 0:null===(e=t.vrm)||void 0===e?void 0:e.humanoid.getNormalizedBoneNode("head");if(r){let e=r.getWorldPosition(new s.Pa4);null===(i=this._camera)||void 0===i||i.position.set(this._camera.position.x,e.y,this._camera.position.z),null===(a=this._cameraControls)||void 0===a||a.target.set(e.x,e.y,e.z),null===(n=this._cameraControls)||void 0===n||n.update()}}constructor(){this.update=()=>{requestAnimationFrame(this.update);let e=this._clock.getDelta();this.model&&this.model.update(e),this._renderer&&this._camera&&this._renderer.render(this._scene,this._camera)},this.isReady=!1;let e=new s.xsS;this._scene=e;let t=new s.Ox3(16777215,1);t.position.set(1,1,1).normalize(),e.add(t);let i=new s.Mig(16777215,1);e.add(i),this._clock=new s.SUY,this._clock.start()}}let N=new L,B=(0,n.createContext)({viewer:N});function F(){let{viewer:e}=(0,n.useContext)(B),t=(0,n.useCallback)(t=>{t&&(e.setup(t),e.loadVrm(S("/Zundamon_VRM_10.vrm")),t.addEventListener("dragover",function(e){e.preventDefault()}),t.addEventListener("drop",function(t){var i;t.preventDefault();let a=null===(i=t.dataTransfer)||void 0===i?void 0:i.files;if(!a)return;let n=a[0];if(n&&"vrm"===n.name.split(".").pop()){let t=new Blob([n],{type:"application/octet-stream"}),i=window.URL.createObjectURL(t);e.loadVrm(i)}}))},[e]);return(0,a.jsx)("div",{style:{position:"absolute",top:0,left:0,width:"100vw",height:"100svh",zIndex:-10},children:(0,a.jsx)("canvas",{ref:t,style:{height:"100%",width:"100%"}})})}let j=e=>{let{iconName:t,isProcessing:i,label:n,...s}=e;return(0,a.jsxs)("button",{...s,className:"bg-primary hover:bg-primary-hover active:bg-primary-press disabled:bg-primary-disabled text-white rounded-16 text-sm p-8 text-center inline-flex items-center mr-2\n        ".concat(s.className,"\n      "),children:[i?(0,a.jsx)("pixiv-icon",{name:"24/Dot",scale:"1"}):(0,a.jsx)("pixiv-icon",{name:t,scale:"1"}),n&&(0,a.jsx)("div",{className:"mx-4 font-bold",children:n})]})};var V=i(7066);let z="https://chat.ikokujin.baby";async function O(){return(await V.Z.get("".concat(z,"/speakers"))).data}async function W(e,t,i){var a;let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"neutral",s=await V.Z.post("".concat(z,"/audio_query"),null,{params:{text:t,speaker:e}}),r=await V.Z.post("".concat(z,"/synthesis"),s.data,{responseType:"arraybuffer",params:{speaker:e}});return null===(a=i.model)||void 0===a?void 0:a.speak(r.data,n)}async function U(e){return(await V.Z.post("".concat("https://tsukutteasobuhackathon.keep-slimbody.workers.dev","/chat"),{message:e})).data}function H(){let{viewer:e}=(0,n.useContext)(B),[t,i]=(0,n.useState)({}),[s,r]=(0,n.useState)("");(0,n.useEffect)(()=>{(async()=>{var e;let t=null===(e=((await O()).find(e=>"ずんだもん"===e.name)||{}).styles)||void 0===e?void 0:e.find(e=>"あまあま"===e.name);t&&i(t)})()},[]);let o=async()=>{if(t.id){var i;let a=((await U(s)).choices||[])[0]||{};(null===(i=a.message)||void 0===i?void 0:i.content)&&await W(t.id,a.message.content,e)}};return(0,a.jsxs)("div",{className:"font-M_PLUS_2",children:[(0,a.jsx)(F,{}),(0,a.jsx)("div",{style:{position:"absolute",bottom:0,zIndex:20,width:"100vw"},children:(0,a.jsx)("div",{style:{backgroundColor:"rgb(251,226,202)",color:"#000000"},children:(0,a.jsx)("div",{style:{marginLeft:"auto",marginRight:"auto",maxWidth:"56rem",padding:"16px"},children:(0,a.jsxs)("div",{style:{display:"grid",gridAutoFlow:"column",gap:"8px",gridTemplateColumns:"min-content 1fr min-content"},children:[(0,a.jsx)(j,{iconName:"24/Microphone",style:{backgroundColor:"rgb(255,97,127)"},className:"bg-secondary hover:bg-secondary-hover active:bg-secondary-press disabled:bg-secondary-disabled",isProcessing:!1,disabled:!1,onClick:o}),(0,a.jsx)("input",{type:"text",placeholder:"聞きたいことをいれてね",onChange:e=>r(e.target.value),disabled:!1,style:{backgroundColor:"#FFFFFF",color:"rgb(81,64,98)",fontSize:"16px",lineHeight:"24px",fontWeight:700,paddingLeft:"16px",paddingRight:"16px",borderRadius:"16px",width:"100%"},className:"bg-surface1 hover:bg-surface1-hover focus:bg-surface1 disabled:bg-surface1-disabled disabled:text-primary-disabled rounded-16 w-full px-16 text-text-primary typography-16 font-bold disabled",value:s}),(0,a.jsx)(j,{iconName:"24/Send",style:{backgroundColor:"rgb(255,97,127)"},className:"bg-secondary hover:bg-secondary-hover active:bg-secondary-press disabled:bg-secondary-disabled",isProcessing:!1,disabled:s.length<=0,onClick:o})]})})})})]})}}},function(e){e.O(0,[3737,8086,4060,2888,9774,179],function(){return e(e.s=8312)}),_N_E=e.O()}]);